<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Emoji Treasure Chest Event</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');

        body {
            margin: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }

        #game-container {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            background: radial-gradient(circle at bottom, #512b58 0%, #2c1055 40%, #000000 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        /* 보물상자 */
        #chest-container {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 30%; /* 상자 크기 살짝 키움 */
            z-index: 10;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.4));
        }

        #chest-container img {
            width: 100%;
            display: block;
        }

        /* 튀어오르는 왕 하트 스타일 */
        .pop-out-heart {
            position: absolute;
            left: 50%; 
            bottom: 20%; /* 상자 내부에서 시작 */
            font-size: 15rem; /* 영상처럼 매우 크게 */
            z-index: 5; /* 상자(10)보다는 뒤, 배경보다는 앞 -> 상자 안에서 나오는 느낌 */
            
            /* 애니메이션 설정 */
            animation: popOutMove 2.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            
            /* 이쁜 하트를 위한 필터 */
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)) brightness(1.2);
            will-change: transform, opacity;
            pointer-events: none;
        }

        /* 하트 내부 (두근거림 효과용) */
        .heart-inner {
            display: block;
            animation: heartBeatInner 1.2s infinite ease-in-out;
        }

        /* 1. 튀어오르는 전체 움직임 */
        @keyframes popOutMove {
            0% {
                transform: translate(-50%, 50%) scale(0.1);
                opacity: 0;
            }
            15% {
                opacity: 1;
                /* 위로 솟구치며 커짐 */
                transform: translate(-50%, -60%) scale(1.2); 
            }
            25% {
                /* 살짝 내려오며 안착 (반동) */
                transform: translate(-50%, -40%) scale(1.0); 
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.0);
            }
            100% {
                opacity: 0;
                /* 서서히 위로 사라짐 */
                transform: translate(-50%, -150%) scale(1.1); 
            }
        }

        /* 2. 하트 자체의 두근거림 */
        @keyframes heartBeatInner {
            0% { transform: scale(1); }
            14% { transform: scale(1.15); } 
            28% { transform: scale(1); }
            42% { transform: scale(1.15); } 
            70% { transform: scale(1); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="chest-container">
            <img src="./chest_3d.png" alt="Treasure Chest" id="chest-img">
            <div id="spawn-point"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const chestContainer = document.getElementById('chest-container');

        let inputListener = null;
        const startTime = Date.now();

        function startListening() {
            const inputRef = db.ref('inputs');
            inputListener = inputRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (data.timestamp && data.timestamp > startTime) {
                    // 입력이 들어오면 하트 팝업 실행
                    spawnBigHeart();
                }
            });
        }

        startListening();

        function spawnBigHeart() {
            // 1. 하트 감싸는 컨테이너 생성
            const heartWrapper = document.createElement('div');
            heartWrapper.classList.add('pop-out-heart');
            
            // 2. 하트 내부 (두근거림용)
            const heartInner = document.createElement('span');
            heartInner.classList.add('heart-inner');
            heartInner.innerText = "❤️"; // 영상처럼 빨간 하트 고정 (원하시면 입력된 이모지로 변경 가능)
            
            heartWrapper.appendChild(heartInner);
            chestContainer.appendChild(heartWrapper);

            // 3. 약간의 랜덤 각도 추가 (너무 정직하게 위로만 가면 재미없으니 -15도 ~ 15도 기울기)
            const randomRotate = (Math.random() * 30) - 15;
            heartInner.style.transform = `rotate(${randomRotate}deg)`;

            // 4. 애니메이션 종료 후 삭제 (메모리 관리)
            heartWrapper.addEventListener('animationend', () => {
                heartWrapper.remove();
            });
        }
    </script>
</body>
</html>
