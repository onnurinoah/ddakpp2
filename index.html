<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Emoji Treasure Chest Event</title>
    <style>
        /* ì´ëª¨ì§€ í°íŠ¸ í†µì¼ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');

        body {
            margin: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }

        #game-container {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            background: radial-gradient(circle at bottom, #512b58 0%, #2c1055 40%, #000000 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        /* ë³´ë¬¼ìƒì */
        #chest-container {
            position: absolute;
            bottom: 2%;
            left: 50%;
            transform: translateX(-50%);
            width: 25%;
            /* [ì¤‘ìš”] ë ˆì´ì–´ ì¤‘ê°„ ë‹¨ê³„ */
            z-index: 10;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.4));
        }

        #chest-container img {
            width: 100%;
            display: block;
        }

        /* ë–¨ì–´ì§€ëŠ” ì•„ì´í…œ */
        .falling-item {
            position: absolute;
            font-size: 3.5rem;
            top: -150px;
            /* [ìˆ˜ì •] ìƒì(10)ë³´ë‹¤ ë†’ê²Œ ì„¤ì •í•˜ì—¬ ìƒì ìœ„ë¡œ ë–¨ì–´ì§€ê²Œ í•¨ */
            z-index: 15;
            will-change: transform, top;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
        }

        /* [ìˆ˜ì •] ë“œë¼ë§ˆí‹±í•œ í‘ íš¨ê³¼ ê°•í™” */
        .poof {
            position: absolute;
            /* [ìˆ˜ì •] í°íŠ¸ ì‚¬ì´ì¦ˆ ëŒ€í­ í™•ëŒ€ */
            font-size: 8rem; 
            transform: translate(-50%, -50%);
            pointer-events: none;
            /* [ìˆ˜ì •] ê·¸ ì–´ë–¤ ê²ƒë³´ë‹¤ ìµœìƒë‹¨ì— ìœ„ì¹˜ */
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: poofDramatic 0.6s ease-out forwards;
        }

        @keyframes poofDramatic {
            0% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(0.5); 
                content: 'âœ¨'; 
                filter: brightness(5); /* ëˆˆë¶€ì‹œê²Œ ì‹œì‘ */
            }
            20% {
                /* ì¾…! í•˜ëŠ” íƒ€ì´ë° */
                transform: translate(-50%, -50%) scale(1.8); 
                content: 'ğŸ’¥';
                filter: brightness(1);
                /* ë¹› ë²ˆì§ íš¨ê³¼ ì¶”ê°€ */
                text-shadow: 0 0 50px rgba(255, 165, 0, 0.8), 0 0 20px rgba(255, 255, 0, 0.8);
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(2.5); 
                filter: blur(4px);
            }
        }

        /* ìŒ“ì´ëŠ” í•˜íŠ¸ */
        .heart-stack {
            position: absolute;
            font-size: 2.5rem;
            /* [ìˆ˜ì •] ìƒì(10)ë³´ë‹¤ëŠ” ìœ„, ë–¨ì–´ì§€ëŠ” ì•„ì´í…œ(15)ë³´ë‹¤ëŠ” ì•„ë˜ -> ìì—°ìŠ¤ëŸ½ê²Œ ìŒ“ì´ëŠ” ëŠë‚Œ */
            z-index: 12;
            transform-origin: center center;
            /* text-shadowë¡œ ì•½ê°„ì˜ ì…ì²´ê° */
            text-shadow: 0 2px 10px rgba(255, 0, 0, 0.4);
        }

        .heart-inner {
            display: block;
            animation: heartbeat 1.2s infinite ease-in-out;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); } 
            28% { transform: scale(1); }
            42% { transform: scale(1.3); } 
            70% { transform: scale(1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="chest-container">
            <img src="./chest_3d.png" alt="Treasure Chest" id="chest-img">
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const container = document.getElementById('game-container');
        const chestContainer = document.getElementById('chest-container');

        const randomEmojis = [
            "ğŸ’", "ğŸ’", "ğŸ‘‘", "ğŸ’°", "ğŸ", "ğŸ§¸", "ğŸ”‘", "ğŸ”®", "ğŸ“·", "ğŸ“±",
            "ğŸ’»", "âŒš", "ğŸ•¶ï¸", "ğŸ’", "ğŸ‘ ", "ğŸ§¢", "ğŸ¸", "ğŸ¨", "ğŸ”", "ğŸ•",
            "ğŸ©", "ğŸ¦", "ğŸ­", "ğŸš—", "âœˆï¸", "ğŸš€", "ğŸ›¸", "ğŸ»", "ğŸº", "ğŸ¥"
        ];

        const heartPile = []; 
        let inputListener = null;
        const startTime = Date.now();

        function startListening() {
            const inputRef = db.ref('inputs');
            inputListener = inputRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (data.timestamp && data.timestamp > startTime) {
                    spawnItem();
                }
            });
        }

        startListening();

        function spawnItem() {
            const item = document.createElement('div');
            item.classList.add('falling-item');
            item.innerText = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
            
            const containerRect = container.getBoundingClientRect();
            const chestRect = chestContainer.getBoundingClientRect();

            const chestLeftPercent = ((chestRect.left - containerRect.left) / containerRect.width) * 100;
            const chestRightPercent = ((chestRect.right - containerRect.left) / containerRect.width) * 100;
            
            const padding = 2; 
            const randomLeft = (chestLeftPercent + padding) + Math.random() * (chestRightPercent - chestLeftPercent - padding * 2);
            
            item.style.left = `${randomLeft}%`;
            
            // ëª©í‘œ ì§€ì : ìƒì ë†’ì´ì˜ 60% ì§€ì  (ë„ˆë¬´ ê¹Šì´ ì•ˆ ë“¤ì–´ê°€ê²Œ)
            const targetTop = chestRect.top - containerRect.top + (chestRect.height * 0.6);

            const duration = 5 + Math.random() * 1; // 5~6ì´ˆ
            item.style.animationName = `fall-${Date.now()}`;
            item.style.animationDuration = `${duration}s`;

            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes ${item.style.animationName} {
                    from { top: -10%; transform: rotate(0deg); }
                    to { top: ${targetTop}px; transform: rotate(${Math.random() * 360}deg); }
                }
            `;
            item.appendChild(style);
            container.appendChild(item);

            item.addEventListener('animationend', () => {
                triggerPoof(item);
            });
        }

        function triggerPoof(item) {
            const rect = item.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const left = rect.left - containerRect.left + (rect.width / 2);
            const top = rect.top - containerRect.top + (rect.height / 2);

            item.remove(); 

            // 1. í‘ íš¨ê³¼ ìƒì„±
            const poof = document.createElement('div');
            poof.classList.add('poof');
            poof.innerText = "âœ¨"; // CSS ì• ë‹ˆë©”ì´ì…˜ì—ì„œ contentë¥¼ ë°”ê¾¸ì§€ë§Œ ì´ˆê¸°ê°’ ì„¤ì •
            poof.style.left = `${left}px`;
            poof.style.top = `${top}px`;
            container.appendChild(poof);
            setTimeout(() => poof.remove(), 600);

            // 2. í•˜íŠ¸ ìŒ“ê¸°
            addHeartToChest(left, top);
        }

        function addHeartToChest(targetX, targetY) {
            const heartWrapper = document.createElement('div');
            heartWrapper.classList.add('heart-stack');
            
            const heartInner = document.createElement('span');
            heartInner.classList.add('heart-inner');
            heartInner.innerText = "â¤ï¸";
            heartWrapper.appendChild(heartInner);
            
            const randomOffsetX = (Math.random() - 0.5) * 40; 
            const randomOffsetY = (Math.random() * 20); // ì•„ë˜ë¡œ ì¡°ê¸ˆë§Œ í¼ì§€ê²Œ

            heartWrapper.style.left = `${targetX + randomOffsetX}px`;
            heartWrapper.style.top = `${targetY + randomOffsetY}px`;
            
            const randomRotation = Math.random() * 60 - 30;
            
            // ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ (JS Transition)
            heartWrapper.style.transform = `translate(-50%, -50%) rotate(${randomRotation}deg) scale(0)`;
            heartWrapper.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            container.appendChild(heartWrapper);
            
            requestAnimationFrame(() => {
                heartWrapper.style.transform = `translate(-50%, -50%) rotate(${randomRotation}deg) scale(1)`;
            });

            heartPile.push(heartWrapper);

            if (heartPile.length > 150) {
                const oldHeart = heartPile.shift();
                oldHeart.style.transition = 'opacity 0.5s';
                oldHeart.style.opacity = '0';
                setTimeout(() => oldHeart.remove(), 500);
            }
        }
    </script>
</body>
</html>
