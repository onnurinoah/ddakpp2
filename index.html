<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Emoji Treasure Chest</title>
    <style>
        body {
            margin: 0;
            background-color: #222; /* ì–´ë‘ìš´ ë°°ê²½ */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }

        /* 16:9 ë¹„ìœ¨ ìœ ì§€ë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ */
        #game-container {
            width: 100vw;
            height: 56.25vw; /* 16:9 ë¹„ìœ¨ */
            max-height: 100vh;
            max-width: 177.78vh; /* 16:9 ë¹„ìœ¨ */
            background: linear-gradient(180deg, #2b1055 0%, #7597de 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* ë³´ë¬¼ìƒì */
        #chest {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 20%; /* í™”ë©´ í¬ê¸°ì— ë¹„ë¡€ */
            z-index: 10;
        }

        #chest img {
            width: 100%;
            display: block;
        }

        /* ë–¨ì–´ì§€ëŠ” ì•„ì´í…œ */
        .falling-item {
            position: absolute;
            font-size: 3rem;
            top: -100px;
            z-index: 5;
            animation: fall linear forwards;
        }

        /* í‘ íš¨ê³¼ */
        .poof {
            position: absolute;
            font-size: 4rem;
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: poofAnim 0.5s ease-out forwards;
            z-index: 20;
        }

        /* ìŒ“ì´ëŠ” í•˜íŠ¸ */
        .heart-stack {
            position: absolute;
            font-size: 2rem;
            z-index: 9;
            transition: all 0.3s ease;
        }

        @keyframes fall {
            to { top: 80%; } /* ìƒì ìœ„ì¹˜ ì¯¤ê¹Œì§€ ë–¨ì–´ì§ */
        }

        @keyframes poofAnim {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); content: 'ğŸ’¥'; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="chest">
            <img src="./chest.png" alt="Treasure Chest">
        </div>
        </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const container = document.getElementById('game-container');
        const chest = document.getElementById('chest');

        // ëœë¤ ì•„ì´í…œ 30ì¢… (ë¬¼ê±´ ê´€ë ¨)
        const randomEmojis = [
            "ğŸ’", "ğŸ’", "ğŸ‘‘", "ğŸ†", "ğŸ", "ğŸ§¸", "ğŸˆ", "ğŸ”®", "ğŸ“·", "ğŸ“±",
            "ğŸ’»", "âŒš", "ğŸ•¶ï¸", "ğŸ’", "ğŸ‘ ", "ğŸ§¢", "ğŸ¸", "ğŸ¨", "ğŸ”", "ğŸ•",
            "ğŸ©", "ğŸ¦", "ğŸ­", "ğŸš—", "âœˆï¸", "ğŸš€", "ğŸ›¸", "ğŸ’°", "ğŸ’³", "ğŸ”‘"
        ];

        // í•˜íŠ¸ê°€ ìŒ“ì¼ ìœ„ì¹˜ (ìƒì ë‚´ë¶€ ëŒ€ëµì  ì¢Œí‘œ)
        const heartPile = []; 

        // Firebaseì—ì„œ ìƒˆë¡œìš´ ì…ë ¥ ê°ì§€
        // 'child_added'ëŠ” ë°ì´í„°ê°€ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ì‹¤í–‰ë©ë‹ˆë‹¤.
        const inputRef = db.ref('inputs');
        
        // ë§ˆì§€ë§‰ìœ¼ë¡œ ì²˜ë¦¬í•œ ì‹œê°„ (ê³¼ê±° ë°ì´í„° ë¡œë”© ë°©ì§€ìš©)
        const startTime = Date.now();

        inputRef.on('child_added', (snapshot) => {
            const data = snapshot.val();
            if (data.timestamp < startTime) return; // ì´ë¯¸ ìˆë˜ ë°ì´í„°ëŠ” ë¬´ì‹œ

            spawnItem();
        });

        function spawnItem() {
            const item = document.createElement('div');
            item.classList.add('falling-item');
            
            // ëœë¤ ì´ëª¨ì§€ ì„ íƒ
            item.innerText = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
            
            // ëœë¤ ê°€ë¡œ ìœ„ì¹˜ (ìƒì ê·¼ì²˜ë¡œ ë–¨ì–´ì§€ê²Œ ìœ ë„í•˜ê±°ë‚˜ ì „ì²´ í™”ë©´)
            // ìƒì ì•ˆìœ¼ë¡œ ë“¤ì–´ê°€ê²Œ í•˜ë ¤ë©´ ë²”ìœ„ë¥¼ ì¢íˆê³ , ì „ì²´ë©´ 0~100%
            // ì—¬ê¸°ì„œëŠ” ìƒì ê·¼ì²˜ë¡œ ëª¨ì´ê²Œ 30% ~ 70% ì‚¬ì´ë¡œ ì„¤ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.
            const randomLeft = 30 + Math.random() * 40; 
            item.style.left = randomLeft + '%';
            
            // ë–¨ì–´ì§€ëŠ” ì†ë„ ëœë¤ (1ì´ˆ ~ 3ì´ˆ)
            const duration = 1 + Math.random() * 2;
            item.style.animationDuration = duration + 's';

            container.appendChild(item);

            // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ ê°ì§€ (ìƒìì— ë‹¿ì•˜ì„ ë•Œ)
            item.addEventListener('animationend', () => {
                triggerPoof(item);
            });
        }

        function triggerPoof(item) {
            // ì•„ì´í…œì˜ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            const rect = item.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // ìƒëŒ€ ì¢Œí‘œ ê³„ì‚°
            const left = rect.left - containerRect.left + (rect.width / 2);
            const top = rect.top - containerRect.top;

            // ì•„ì´í…œ ì œê±°
            item.remove();

            // 1. í‘ íš¨ê³¼ ìƒì„±
            const poof = document.createElement('div');
            poof.classList.add('poof');
            poof.innerText = "ğŸ’¥"; // í˜¹ì€ ğŸ’¨
            poof.style.left = left + 'px';
            poof.style.top = top + 'px';
            container.appendChild(poof);
            
            setTimeout(() => poof.remove(), 500);

            // 2. í•˜íŠ¸ë¡œ ë³€ì‹ í•˜ì—¬ ìŒ“ì´ê¸°
            addHeartToChest(left, top);
        }

        function addHeartToChest(x, y) {
            const heart = document.createElement('div');
            heart.classList.add('heart-stack');
            heart.innerText = "â¤ï¸";
            
            // ìƒì ì•ˆìª½ ì–´ë”˜ê°€ì— ëœë¤í•˜ê²Œ ë°°ì¹˜ë˜ëŠ” ëŠë‚Œ
            // ìƒìì˜ ìœ„ì¹˜ ê¸°ì¤€:
            const chestRect = chest.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // ìƒì ë‚´ë¶€ ì¢Œí‘œ (ëŒ€ëµì )
            const chestCenterX = (chestRect.left - containerRect.left) + (chestRect.width / 2);
            const chestBottomY = (chestRect.top - containerRect.top) + (chestRect.height * 0.7);

            // í•˜íŠ¸ê°€ ìŒ“ì¼ ëœë¤ ìœ„ì¹˜ (ì¤‘ì‹¬ë¶€ ì£¼ë³€)
            const randomX = chestCenterX + (Math.random() * 100 - 50); // ì¤‘ì‹¬ Â±50px
            const randomY = chestBottomY - (Math.random() * 50); // ë°”ë‹¥ì—ì„œ ìœ„ë¡œ 50px

            heart.style.left = randomX + 'px';
            heart.style.top = randomY + 'px';
            
            // ì²˜ìŒì—” íˆ¬ëª…í–ˆë‹¤ê°€ ë‚˜íƒ€ë‚˜ê±°ë‚˜, ìœ„ì—ì„œ íˆ­ ë–¨ì–´ì§€ëŠ” ëŠë‚Œ
            container.appendChild(heart);

            // ë„ˆë¬´ ë§ì´ ìŒ“ì´ë©´ ë¸Œë¼ìš°ì € ëŠë ¤ì§ ë°©ì§€ (ìµœê·¼ 100ê°œë§Œ ìœ ì§€)
            heartPile.push(heart);
            if (heartPile.length > 100) {
                const oldHeart = heartPile.shift();
                oldHeart.remove();
            }
        }
    </script>
</body>
</html>
