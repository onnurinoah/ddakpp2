<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Emoji Treasure Chest Event</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');

        body {
            margin: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
            perspective: 1000px; /* 3D ì›ê·¼ê° ì¶”ê°€ */
        }

        #game-container {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            background: radial-gradient(circle at bottom, #512b58 0%, #2c1055 40%, #000000 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
        }

        /* ë³´ë¬¼ìƒì */
        #chest-container {
            position: absolute;
            bottom: 12%; /* ë°”ë‹¥ì—ì„œ ì‚´ì§ ë„ì›€ */
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            z-index: 20; 
            /* ìƒì ìì²´ë„ ì‚´ì§ ë¹›ë‚˜ê²Œ */
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.3));
        }

        #chest-container img {
            width: 100%;
            display: block;
        }

        /* ë‚ ì•„ê°€ëŠ” ì•„ì´í…œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .flying-item {
            position: absolute;
            left: 50%; 
            bottom: 25%; /* ìƒì ì…êµ¬ ì•ˆìª½ì—ì„œ ì‹œì‘ */
            font-size: 3.5rem; /* í¬ê¸° ì ë‹¹íˆ ìœ ì§€ */
            z-index: 15; /* ìƒìë³´ë‹¤ëŠ” ë’¤, ìŒ“ì¸ ê²ƒë³´ë‹¤ëŠ” ì• */
            user-select: none;
            pointer-events: none;
            will-change: transform, opacity;
            
            /* 3D í…ìŠ¤íŠ¸ íš¨ê³¼ (ë‘ê»˜ê° í‘œí˜„) */
            text-shadow: 
                0px 1px 0px #990000,
                0px 2px 0px #990000,
                0px 3px 0px #990000,
                0px 4px 5px rgba(0,0,0,0.5);
            
            /* CSS ë³€ìˆ˜ë¡œ ëœë¤ ë„ì°© ì§€ì  ì œì–´ */
            --end-x: 0px; 
            --end-y: 0px;
            --rotate-x: 0deg;
            --rotate-y: 0deg;
            --rotate-z: 0deg;

            /* ì• ë‹ˆë©”ì´ì…˜: ì§§ê³  êµµê²Œ íŠ€ì–´ì˜¤ë¦„ */
            animation: jumpAndStack 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }

        /* ë³€ì‹ í•  ë•Œ 'í‘' í•˜ëŠ” íš¨ê³¼ */
        .poof-effect {
            animation: poofFlash 0.4s ease-out;
        }

        /* ë°”ë‹¥ì— ìŒ“ì¸ ìƒíƒœ (ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„) */
        .landed {
            position: absolute;
            /* ìƒì ë°”ë¡œ ì•~ìœ„ìª½ì— ìŒ“ì´ë„ë¡ z-index ì¡°ì ˆì´ í•„ìš”í•  ìˆ˜ ìˆìŒ */
            z-index: 25; 
            animation: none; 
            
            /* ìµœì¢… ìœ„ì¹˜ì— ê³ ì • + ì…ì²´ì ìœ¼ë¡œ ëˆ•íˆê¸° */
            transform: 
                translate3d(var(--end-x), var(--end-y), 0) 
                rotateX(var(--rotate-x)) 
                rotateY(var(--rotate-y)) 
                rotateZ(var(--rotate-z));
            
            /* ìŒ“ì¸ í•˜íŠ¸ëŠ” ê·¸ë¦¼ìë¥¼ ë” ì§„í•˜ê²Œ */
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6));
            transition: transform 0.2s; /* ìŒ“ì¼ ë•Œ ë¶€ë“œëŸ½ê²Œ */
        }

        /* ì í”„ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes jumpAndStack {
            0% {
                opacity: 0;
                transform: translate3d(-50%, 0, 0) scale(0.5);
            }
            10% {
                opacity: 1;
                transform: translate3d(-50%, -100px, 0) scale(1.1); /* íŠ€ì–´ë‚˜ì˜¤ëŠ” ìˆœê°„ */
            }
            40% {
                /* ê³µì¤‘ ì •ì  (ë” ë†’ì´) */
                transform: translate3d(-50%, -350px, 50px) scale(1.3);
            }
            100% {
                /* ì§€ì •ëœ ì¢Œí‘œë¡œ ë‚™í•˜ (3D íšŒì „ ì ìš©) */
                transform: 
                    translate3d(var(--end-x), var(--end-y), 0) 
                    rotateX(var(--rotate-x)) 
                    rotateY(var(--rotate-y)) 
                    rotateZ(var(--rotate-z)) 
                    scale(1);
            }
        }

        /* ì´ëª¨ì§€ -> í•˜íŠ¸ ë³€ì‹  ì‹œ ë²ˆì©ì„ */
        @keyframes poofFlash {
            0% { filter: brightness(3) contrast(2); transform: scale(1.4); }
            50% { filter: brightness(2); transform: scale(1.2); }
            100% { filter: brightness(1); transform: scale(1); }
        }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="chest-container">
            <img src="./chest_3d.png" alt="Treasure Chest" id="chest-img">
        </div>
        <div id="pile-container"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const chestContainer = document.getElementById('chest-container');
        
        // ì¤‘ìš”: í•˜íŠ¸ê°€ ìŒ“ì¼ ê¸°ì¤€ì ì€ ìƒì ì»¨í…Œì´ë„ˆ ë‚´ë¶€ê°€ ì•„ë‹ˆë¼ ìƒìì™€ ê°™ì€ ë ˆë²¨ì´ì–´ì•¼ ìì—°ìŠ¤ëŸ¬ì›€
        // í•˜ì§€ë§Œ ì¢Œí‘œ ê³„ì‚° í¸ì˜ë¥¼ ìœ„í•´ chestContainerì— ë„£ê³  ìœ„ì¹˜ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.
        
        let inputListener = null;
        const startTime = Date.now();

        function startListening() {
            const inputRef = db.ref('inputs');
            inputListener = inputRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (data.timestamp && data.timestamp > startTime) {
                    const receivedEmoji = data.emoji || data.text || "â“";
                    spawnEmojiToHeart(receivedEmoji);
                }
            });
        }

        startListening();

        function spawnEmojiToHeart(emojiChar) {
            const item = document.createElement('div');
            item.classList.add('flying-item');
            item.innerText = emojiChar; 

            // --- ì¢Œí‘œ ì„¤ì • (ìƒì ìœ„ì— ìˆ˜ë¶ì´ ìŒ“ì´ê²Œ) ---
            
            // X: ìƒì ë„ˆë¹„ë³´ë‹¤ ì•½ê°„ ì¢ê²Œ (-15% ~ 15% ì •ë„ ë²”ìœ„)
            // í™”ë©´ í”½ì…€ ê¸°ì¤€ìœ¼ë¡œ ëŒ€ëµ -150px ~ 150px
            const randomX = (Math.random() * 300) - 150; 
            
            // Y: ìƒì ì…êµ¬ ~ ë°”ë‹¥ ì‚¬ì´ (0px ~ 150px ì•„ë˜ë¡œ)
            // ê°’ì´ í´ìˆ˜ë¡ ì•„ë˜ë¡œ ë‚´ë ¤ê°‘ë‹ˆë‹¤. ìƒì ì…êµ¬ê°€ 0 ê¸°ì¤€.
            // ë” ì…ì²´ì ìœ¼ë¡œ ìŒ“ì´ê²Œ í•˜ê¸° ìœ„í•´ ëœë¤ ë¶„í¬
            const randomY = (Math.random() * 120) - 20; 

            // 3D íšŒì „ (ë°”ë‹¥ì— í©ë¿Œë ¤ì§„ ëŠë‚Œ)
            // RotateX: 40~70ë„ (ëˆ„ì›ŒìˆëŠ” ê°ë„)
            const rotateX = 40 + (Math.random() * 30);
            const rotateY = (Math.random() * 40) - 20;
            const rotateZ = (Math.random() * 60) - 30;

            item.style.setProperty('--end-x', `${randomX}px`);
            item.style.setProperty('--end-y', `${randomY}px`);
            item.style.setProperty('--rotate-x', `${rotateX}deg`);
            item.style.setProperty('--rotate-y', `${rotateY}deg`);
            item.style.setProperty('--rotate-z', `${rotateZ}deg`);

            chestContainer.appendChild(item);

            // --- ë³€ì‹  ë¡œì§ (íƒ€ì´ë° ë‹¨ì¶•) ---
            // 0.2ì´ˆ(200ms) ë§Œì— ë°”ë¡œ ë³€ì‹  (íŠ€ì–´ì˜¤ë¥´ëŠ” ë„ì¤‘)
            setTimeout(() => {
                item.innerText = "â¤ï¸";
                item.classList.add('poof-effect');
            }, 200); 

            // --- ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ ì²˜ë¦¬ ---
            item.addEventListener('animationend', () => {
                item.classList.remove('flying-item');
                item.classList.remove('poof-effect');
                item.classList.add('landed');

                // ì…ì²´ê°ì„ ìœ„í•´ ìŒ“ì¸ ìˆœì„œëŒ€ë¡œ z-index ë¯¸ì„¸ ì¡°ì • + ëœë¤ì„±
                // ìƒì ì•ìª½ìœ¼ë¡œ í˜ëŸ¬ë‚´ë¦° ê²ƒ(Yê°’ì´ í° ê²ƒ)ì´ ë” ì•ì— ì™€ì•¼ í•¨
                const depthZ = Math.floor(randomY) + 30; 
                item.style.zIndex = depthZ;
            });
        }

        // --- í…ŒìŠ¤íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ ---
        document.body.addEventListener('click', () => {
             const randomEmojis = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š"];
             const pick = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
             spawnEmojiToHeart(pick);
        });

    </script>
</body>
</html>
