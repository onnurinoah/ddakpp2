<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë”°í¬í”„ ì¶”ì–µìƒì</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');

        body {
            margin: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
            perspective: 1200px; /* ì›ê·¼ê° ê°•í™” */
        }

        #game-container {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            background: radial-gradient(circle at bottom, #512b58 0%, #2c1055 40%, #000000 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
        }

        /* ë³´ë¬¼ìƒì ì»¨í…Œì´ë„ˆ */
        #chest-wrapper {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            height: auto;
            z-index: 50; /* í•˜íŠ¸ë“¤ ì‚¬ì´ì—ì„œ ìœ„ì¹˜ ì¡ê¸° ìœ„í•´ */
            transform-style: preserve-3d;
        }

        #chest-img {
            width: 100%;
            display: block;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.2));
            position: relative;
            z-index: 50;
        }

        /* í•˜íŠ¸ë“¤ì´ ìŒ“ì´ëŠ” ë ˆì´ì–´ (ìƒì ìœ„ì¹˜ ê¸°ì¤€) */
        #pile-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            transform-style: preserve-3d;
        }

        /* ê³µí†µ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .item {
            position: absolute;
            left: 50%;
            bottom: 25%; /* ë°œì‚¬ ì‹œì‘ì  (ìƒì ë‚´ë¶€) */
            font-size: 3.5rem;
            user-select: none;
            will-change: transform;
            
            /* 3D í…ìŠ¤íŠ¸ ë‘ê»˜ê° */
            text-shadow: 
                0px 1px 0px #800000,
                0px 2px 0px #600000,
                0px 3px 5px rgba(0,0,0,0.6);
        }

        /* 1. ë‚ ì•„ê°€ëŠ” ìƒíƒœ (ì• ë‹ˆë©”ì´ì…˜ ì¤‘) */
        .flying {
            z-index: 100; /* ë‚ ì•„ê°ˆ ë• ê°€ì¥ ì•ì— */
            --tx: 0px; --ty: 0px; --rz: 0deg; --rx: 0deg;
            animation: jump 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }

        /* 2. ë°”ë‹¥ì— ìŒ“ì¸ ìƒíƒœ (ì •ì ) */
        .landed {
            /* z-indexëŠ” JSì—ì„œ ê¹Šì´ì— ë”°ë¼ ë™ì  ë¶€ì—¬ */
            transform-origin: center bottom;
            /* JSì—ì„œ ê³„ì‚°ëœ ìµœì¢… ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ê³ ì • */
            transform: 
                translate3d(var(--tx), var(--ty), 0) 
                rotateX(var(--rx)) 
                rotateY(var(--ry)) 
                rotateZ(var(--rz));
            
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }

        /* í‘ í„°ì§€ëŠ” íš¨ê³¼ */
        .poof {
            animation: poofAnim 0.3s ease-out forwards;
        }

        @keyframes jump {
            0% {
                opacity: 0;
                transform: translate3d(-50%, 0, 0) scale(0.5);
            }
            15% {
                opacity: 1;
                transform: translate3d(-50%, -120px, 50px) scale(1.1);
            }
            50% {
                /* ì •ì : ìœ„ë¡œ ì†Ÿêµ¬ì¹¨ */
                transform: translate3d(-50%, -350px, 100px) scale(1.3);
            }
            100% {
                /* ëª©í‘œ ì§€ì  ì°©ì§€ */
                transform: 
                    translate3d(var(--tx), var(--ty), 0) 
                    rotateX(var(--rx)) 
                    rotateY(var(--ry)) 
                    rotateZ(var(--rz)) 
                    scale(1);
            }
        }

        @keyframes poofAnim {
            0% { filter: brightness(3); transform: scale(1.5); }
            100% { filter: brightness(1); transform: scale(1); }
        }

        /* ë””ë²„ê¹…/í…ŒìŠ¤íŠ¸ ë²„íŠ¼ìš© (í•„ìš”ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬) */
        #debug-area {
            position: absolute; top: 10px; left: 10px; z-index: 9999;
            color: white; font-size: 12px; opacity: 0.5;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="chest-wrapper">
            <img src="./chest_3d.png" alt="Chest" id="chest-img">
            <div id="pile-layer"></div>
        </div>
        
        <div id="debug-area">Click anywhere to test input</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const pileLayer = document.getElementById('pile-layer');
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œê°„ (ì´ ì‹œê°„ ì´ì „ ë°ì´í„°ëŠ” ì• ë‹ˆë©”ì´ì…˜ ìƒëµ)
        const loadTime = Date.now();
        // 1ì‹œê°„ ì „ ì‹œê°„ ê³„ì‚° (ë°€ë¦¬ì´ˆ: 60ë¶„ * 60ì´ˆ * 1000)
        const oneHourAgo = loadTime - (60 * 60 * 1000);

        function startApp() {
            // timestampê°€ 1ì‹œê°„ ì „ ~ í˜„ì¬/ë¯¸ë˜ ì¸ ë°ì´í„°ë§Œ ì¿¼ë¦¬
            const inputRef = db.ref('inputs')
                .orderByChild('timestamp')
                .startAt(oneHourAgo);

            inputRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                // ë°ì´í„°ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê°„ì£¼
                const itemTime = data.timestamp || Date.now();
                
                // 1ì‹œê°„ì´ ì§€ë‚¬ëŠ”ì§€ í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œë„ í•œë²ˆ ë” ì²´í¬ (ì•ˆì „ì¥ì¹˜)
                if (itemTime < oneHourAgo) return;

                const emoji = data.emoji || data.text || "â¤ï¸";
                
                // í˜ì´ì§€ ë¡œë“œë³´ë‹¤ ì´ì „ì— ìƒì„±ëœ ë°ì´í„°ì¸ê°€? (ìƒˆë¡œê³ ì¹¨ ì‹œ ë³µì›ìš©)
                // ì•½ê°„ì˜ ë²„í¼(2ì´ˆ)ë¥¼ ë‘ì–´ ë¡œë”© ì§í›„ ë“¤ì–´ì˜¨ ë°ì´í„°ë„ ì²˜ë¦¬
                const isHistory = itemTime < (loadTime - 2000);

                spawnItem(emoji, isHistory);
            });
        }

        startApp();

        function spawnItem(emojiChar, isHistory) {
            const el = document.createElement('div');
            el.classList.add('item');

            // --- [í•µì‹¬] ì¢Œí‘œ ê³„ì‚° ì•Œê³ ë¦¬ì¦˜ (ìƒì ì•ìª½ìœ¼ë¡œ íë¥´ê²Œ) ---
            
            // 1. Xì¢Œí‘œ: ì •ê·œë¶„í¬ ëŠë‚Œ (ì¤‘ì•™ì— ëª°ë¦¬ê³  ì–‘ì˜†ìœ¼ë¡œ í¼ì§)
            // -180px ~ +180px ë²”ìœ„
            let x = (Math.random() - 0.5) * 2; // -1 ~ 1
            x = x * x * x; // 3ì œê³±í•˜ì—¬ ì¤‘ì•™ê°’(0) ê·¼ì²˜ í™•ë¥ ì„ ë†’ì„
            const finalX = x * 250; // í¼ì§ ì •ë„ ì¡°ì ˆ

            // 2. Yì¢Œí‘œ: Xê°€ ì¤‘ì•™ì¼ìˆ˜ë¡ ìœ„ìª½(ìƒì ì•ˆ), Xê°€ ëì¼ìˆ˜ë¡ ì•„ë˜ìª½(ë°”ë‹¥)
            // ìƒì ì…êµ¬ ~ ì•ìª½ ë°”ë‹¥
            const randomDepth = Math.random(); 
            // ê¸°ë³¸ Y: 0(ì…êµ¬) ~ 150(ë°”ë‹¥)
            let finalY = (randomDepth * 120) - 30; 
            
            // Xê°€ ë©€ì–´ì§ˆìˆ˜ë¡ Yë„ ë‚´ë ¤ê°€ê²Œ ë³´ì • (ë¶€ì±„ê¼´ í˜•íƒœ)
            finalY += Math.abs(finalX) * 0.3;

            // 3. íšŒì „ (ë°”ë‹¥ì— ë–¨ì–´ì§„ ëŠë‚Œ)
            const rx = 50 + (Math.random() * 30); // 50~80ë„ ëˆ•í˜
            const ry = (Math.random() - 0.5) * 40; // ì¢Œìš° ë¹„í‹€ê¸°
            const rz = (Math.random() - 0.5) * 60; // ëœë¤ íšŒì „

            // CSS ë³€ìˆ˜ ì£¼ì…
            el.style.setProperty('--tx', `${finalX}px`);
            el.style.setProperty('--ty', `${finalY}px`);
            el.style.setProperty('--rx', `${rx}deg`);
            el.style.setProperty('--ry', `${ry}deg`);
            el.style.setProperty('--rz', `${rz}deg`);

            // 4. ê¹Šì´(Z-Index) ì„¤ì •: í™”ë©´ ì•„ë˜ìª½(Yê°€ í° ê°’)ì¼ìˆ˜ë¡ ì•ì— ì™€ì•¼ í•¨
            // ìƒìê°€ z-index 50ì´ë¯€ë¡œ, ê·¸ ê·¼ì²˜ì—ì„œ ë†€ê²Œ ì„¤ì •
            // ìƒì ì•ˆìª½(-Y)ì€ ë’¤ë¡œ, ë°”ë‹¥ìª½(+Y)ì€ ì•ìœ¼ë¡œ
            const zIndexBase = 50; 
            el.style.zIndex = Math.floor(zIndexBase + finalY);

            pileLayer.appendChild(el);

            if (isHistory) {
                // [ê³¼ê±° ë°ì´í„°] ì• ë‹ˆë©”ì´ì…˜ ìŠ¤í‚µ, ë°”ë¡œ í•˜íŠ¸ë¡œ ë³€í™˜ ë° ìœ„ì¹˜ ê³ ì •
                el.innerText = "â¤ï¸";
                el.classList.add('landed');
            } else {
                // [ì‹¤ì‹œê°„ ë°ì´í„°] ì´ëª¨ì§€ë¡œ ì‹œì‘ -> íŠ€ì–´ì˜¤ë¦„ -> í•˜íŠ¸ ë³€ì‹ 
                el.innerText = emojiChar;
                el.classList.add('flying');

                // 0.2ì´ˆ í›„ í•˜íŠ¸ë¡œ ë³€ì‹  (í‘!)
                setTimeout(() => {
                    el.innerText = "â¤ï¸";
                    el.classList.add('poof');
                }, 200);

                // ì• ë‹ˆë©”ì´ì…˜ ëë‚˜ë©´ ì •ì  ìƒíƒœë¡œ ì „í™˜
                el.addEventListener('animationend', () => {
                    el.classList.remove('flying');
                    el.classList.remove('poof');
                    el.classList.add('landed');
                });
            }

            // (ì„ íƒì‚¬í•­) 1000ê°œê°€ ë„˜ì–´ê°€ë©´ DOM ìµœì í™”ë¥¼ ìœ„í•´ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œí•  ìˆ˜ë„ ìˆìŒ
            // ìš”ì²­ì‚¬í•­ì— "ì‚¬ë¼ì§€ì§€ ì•Šê²Œ"ë¼ê³  í•˜ì…¨ìœ¼ë¯€ë¡œ ì‚­ì œ ë¡œì§ì€ ë„£ì§€ ì•ŠìŒ.
        }

        // --- í…ŒìŠ¤íŠ¸ìš© í´ë¦­ ì´ë²¤íŠ¸ (ì‹¤ì œ ë°°í¬ì‹œ ì œê±°í•˜ê±°ë‚˜ ìœ ì§€ ê°€ëŠ¥) ---
        // í´ë¦­í•˜ë©´ 'ìƒˆë¡œìš´ ë°ì´í„°'ì²˜ëŸ¼ ë™ì‘
        document.body.addEventListener('click', (e) => {
            // í´ë¦­ì€ DB ì“°ê¸°ê°€ ì•„ë‹ˆë¼ ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© í•¨ìˆ˜ í˜¸ì¶œ
            const emojis = ["ğŸ”¥", "âœ¨", "ğŸ", "ğŸ’", "â­ï¸"];
            const pick = emojis[Math.floor(Math.random() * emojis.length)];
            
            // DBì— ì‹¤ì œë¡œ ì˜ëŠ” ì‹œë®¬ë ˆì´ì…˜ (ì›í•˜ì‹œë©´ ì•„ë˜ ì£¼ì„ í•´ì œí•˜ì—¬ DB í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
            /*
            db.ref('inputs').push({
                emoji: pick,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            */
           
            // ì‹œê°ì  í…ŒìŠ¤íŠ¸ë§Œ
            spawnItem(pick, false); 
        });

    </script>
</body>
</html>
