<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Emoji Treasure Chest Event</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');

        body {
            margin: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
            perspective: 1200px;
        }

        #game-container {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            background: radial-gradient(circle at bottom, #512b58 0%, #2c1055 40%, #000000 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
        }

        /* ë³´ë¬¼ìƒì ì»¨í…Œì´ë„ˆ */
        #chest-wrapper {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            height: auto;
            /* z-indexë¥¼ ë‚®ì¶°ì„œ ì•„ì´í…œë“¤ì´ ì›¬ë§Œí•˜ë©´ ì´ ìœ„ë¡œ ì˜¬ë¼ì˜¤ê²Œ ì„¤ì • */
            z-index: 10; 
            transform-style: preserve-3d;
        }

        #chest-img {
            width: 100%;
            display: block;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.2));
            position: relative;
            /* ì´ë¯¸ì§€ëŠ” ì»¨í…Œì´ë„ˆ ë°”ë‹¥ì— ê¹”ë¦¼ */
            z-index: 10; 
        }

        /* í•˜íŠ¸ë“¤ì´ ìŒ“ì´ëŠ” ë ˆì´ì–´ */
        #pile-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            transform-style: preserve-3d;
            /* ë ˆì´ì–´ ìì²´ë¥¼ ìƒìë³´ë‹¤ ì•ìœ¼ë¡œ */
            z-index: 20; 
        }

        /* ì•„ì´í…œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .item {
            position: absolute;
            left: 50%;
            bottom: 25%; /* ìƒì ì…êµ¬ ë¶€ê·¼ì—ì„œ ì‹œì‘ */
            font-size: 3.5rem;
            user-select: none;
            will-change: transform; /* ì„±ëŠ¥ ìµœì í™” í•µì‹¬ */
            
            /* 3D í…ìŠ¤íŠ¸ ë‘ê»˜ê° (ê°€ë²¼ìš´ ê·¸ë¦¼ì) */
            text-shadow: 
                0px 1px 0px #800000,
                0px 2px 0px #600000,
                0px 3px 5px rgba(0,0,0,0.3);
        }

        /* 1. ë‚ ì•„ê°€ëŠ” ìƒíƒœ */
        .flying {
            z-index: 9999 !important; /* ë‚ ì•„ê°ˆ ë• ë¬´ì¡°ê±´ ë§¨ ì• */
            --tx: 0px; --ty: 0px; --rz: 0deg; --rx: 0deg;
            
            /* ì‹œê°„ 2ë°°ë¡œ ëŠ˜ë¦¼ (1.2s -> 2.4s) */
            animation: jump 2.4s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }

        /* 2. ë°”ë‹¥ì— ìŒ“ì¸ ìƒíƒœ */
        .landed {
            transform-origin: center bottom;
            transform: 
                translate3d(var(--tx), var(--ty), 0) 
                rotateX(var(--rx)) 
                rotateY(var(--ry)) 
                rotateZ(var(--rz));
            
            /* ì°©ì§€í•œ ë’¤ì—ë§Œ ë¬´ê±°ìš´ ê·¸ë¦¼ì ì ìš© (ë ‰ ë°©ì§€) */
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
            transition: filter 0.3s;
        }

        .poof {
            animation: poofAnim 0.3s ease-out forwards;
        }

        @keyframes jump {
            0% {
                opacity: 0;
                transform: translate3d(-50%, 0, 0) scale(0.5);
            }
            10% {
                opacity: 1;
                /* ìœ„ë¡œ ì†Ÿêµ¬ì¹¨ */
                transform: translate3d(-50%, -150px, 100px) scale(1.1);
            }
            40% {
                /* ì •ì  */
                transform: translate3d(-50%, -400px, 150px) scale(1.3);
            }
            100% {
                /* ì°©ì§€ */
                transform: 
                    translate3d(var(--tx), var(--ty), 0) 
                    rotateX(var(--rx)) 
                    rotateY(var(--ry)) 
                    rotateZ(var(--rz)) 
                    scale(1);
            }
        }

        @keyframes poofAnim {
            0% { filter: brightness(3); transform: scale(1.5); }
            100% { filter: brightness(1); transform: scale(1); }
        }

        /* í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ UI */
        #controls {
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 10000;
            display: flex;
            gap: 10px;
        }

        button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transition: 0.2s;
        }
        button:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.05); }
        button:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="chest-wrapper">
            <img src="./chest_3d.png" alt="Chest" id="chest-img">
            <div id="pile-layer"></div>
        </div>
        
        <div id="controls">
            <button onclick="testExplosion()">âš¡ 500ê°œ ë°œì‚¬ í…ŒìŠ¤íŠ¸</button>
            <button onclick="clearItems()">ğŸ—‘ï¸ ì²­ì†Œí•˜ê¸°</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        // Firebase ì„¤ì •ì´ ì—†ì–´ë„ ì—ëŸ¬ë‚˜ì§€ ì•Šê²Œ ì˜ˆì™¸ì²˜ë¦¬ (í…ŒìŠ¤íŠ¸ìš©)
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.log("Firebase config missing - running in offline test mode");
        }

        const pileLayer = document.getElementById('pile-layer');
        let db;
        try { db = firebase.database(); } catch(e){}

        const loadTime = Date.now();
        const oneHourAgo = loadTime - (60 * 60 * 1000);

        function startApp() {
            if(!db) return; // DB ì—†ìœ¼ë©´ ì¤‘ë‹¨

            const inputRef = db.ref('inputs')
                .orderByChild('timestamp')
                .startAt(oneHourAgo);

            inputRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                const itemTime = data.timestamp || Date.now();
                if (itemTime < oneHourAgo) return;

                const emoji = data.emoji || data.text || "â¤ï¸";
                const isHistory = itemTime < (loadTime - 2000);

                spawnItem(emoji, isHistory);
            });
        }

        startApp();

        // --- ì•„ì´í…œ ìƒì„± í•µì‹¬ ë¡œì§ ---
        function spawnItem(emojiChar, isHistory) {
            const el = document.createElement('div');
            el.classList.add('item');

            // 1. ìœ„ì¹˜ ê³„ì‚° (Xì¶• í¼ì§)
            let x = (Math.random() - 0.5) * 2; 
            x = x * x * x; // ì¤‘ì•™ ì§‘ì¤‘í˜• ë¶„í¬
            const finalX = x * 280; // í¼ì§ ì •ë„ ì•½ê°„ ì¦ê°€

            // 2. ê¹Šì´ ê³„ì‚° (Yì¶•: ìƒì ì•ˆ~ì•ë°”ë‹¥)
            const randomDepth = Math.random(); 
            // -20(ì•½ê°„ ì•ˆìª½) ~ 180(ì•ìª½ ë°”ë‹¥) -> ëŒ€ë¶€ë¶„ ì•ìª½ìœ¼ë¡œ ì˜¤ê²Œ ì¡°ì •
            let finalY = (randomDepth * 200) - 20; 
            
            // Xê°€ ë©€ì–´ì§ˆìˆ˜ë¡ Yë„ ë‚´ë ¤ê°€ê²Œ(ë¶€ì±„ê¼´)
            finalY += Math.abs(finalX) * 0.4;

            // 3. íšŒì „
            const rx = 60 + (Math.random() * 20); // ë§ì´ ëˆ•í˜
            const ry = (Math.random() - 0.5) * 50;
            const rz = (Math.random() - 0.5) * 90;

            el.style.setProperty('--tx', `${finalX}px`);
            el.style.setProperty('--ty', `${finalY}px`);
            el.style.setProperty('--rx', `${rx}deg`);
            el.style.setProperty('--ry', `${ry}deg`);
            el.style.setProperty('--rz', `${rz}deg`);

            // 4. Z-Index ìš°ì„ ìˆœìœ„ ì¡°ì • (ìƒìê°€ ê°€ë¦¬ì§€ ì•Šê²Œ)
            // ìƒì ì´ë¯¸ì§€ëŠ” z-index: 10 ì…ë‹ˆë‹¤.
            // ì•„ì´í…œì€ ê¸°ë³¸ 20ë¶€í„° ì‹œì‘í•´ì„œ Yê°€ í´ìˆ˜ë¡(ì•ì¼ìˆ˜ë¡) ë” ë†’ê²Œ ì„¤ì •
            const zIndexBase = 20; 
            el.style.zIndex = Math.floor(zIndexBase + finalY);

            pileLayer.appendChild(el);

            if (isHistory) {
                el.innerText = "â¤ï¸";
                el.classList.add('landed');
            } else {
                el.innerText = emojiChar;
                el.classList.add('flying');

                // 2.4s ì• ë‹ˆë©”ì´ì…˜ ì¤‘ í‘ í„°ì§€ëŠ” íƒ€ì´ë° (ì•½ 0.4ì´ˆ ì‹œì )
                setTimeout(() => {
                    el.innerText = "â¤ï¸";
                    el.classList.add('poof');
                }, 400); // ì†ë„ ëŠë ¤ì¡Œìœ¼ë‹ˆ ë³€ì‹  íƒ€ì´ë°ë„ ì¡°ê¸ˆ ëŠ¦ì¶¤

                el.addEventListener('animationend', () => {
                    el.classList.remove('flying');
                    el.classList.remove('poof');
                    el.classList.add('landed');
                });
            }
        }

        // --- [í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥] 500ê°œ í­ë°œ ---
        function testExplosion() {
            const emojis = ["ğŸ”¥", "âœ¨", "ğŸ", "ğŸ’", "â­ï¸", "ğŸ’–", "ğŸ‰"];
            const count = 500;
            
            // ë¸Œë¼ìš°ì € ë ‰ ë°©ì§€ë¥¼ ìœ„í•´ 1ì´ˆ(1000ms) ë™ì•ˆ ë‚˜ëˆ„ì–´ì„œ ìƒì„± (Staggering)
            for (let i = 0; i < count; i++) {
                // ëœë¤í•œ ë”œë ˆì´ë¥¼ ì¤Œ (0 ~ 1000ms ì‚¬ì´)
                const delay = Math.random() * 1000;
                
                setTimeout(() => {
                    const pick = emojis[Math.floor(Math.random() * emojis.length)];
                    spawnItem(pick, false);
                }, delay);
            }
        }

        function clearItems() {
            pileLayer.innerHTML = '';
        }

        // í™”ë©´ í´ë¦­ ì‹œ 1ê°œì”© í…ŒìŠ¤íŠ¸
        document.body.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON') return; // ë²„íŠ¼ í´ë¦­ ì œì™¸
            spawnItem("ğŸ’", false); 
        });

    </script>
</body>
</html>
