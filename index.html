<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Emoji Treasure Chest Event</title>
    <style>
        /* ì´ëª¨ì§€ í°íŠ¸ í†µì¼ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');

        body {
            margin: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            /* ìœˆë„ìš°/ë§¥ ëª¨ë‘ ì˜ˆìœ ì´ëª¨ì§€ë¥¼ ìœ„í•´ í°íŠ¸ ì„¤ì • */
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }

        #game-container {
            width: 100vw;
            height: 56.25vw; /* 16:9 aspect ratio */
            max-height: 100vh;
            max-width: 177.78vh; /* 16:9 aspect ratio */
            /* ì¢€ ë” ì‹ ë¹„ë¡œìš´ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ */
            background: radial-gradient(circle at bottom, #512b58 0%, #2c1055 40%, #000000 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        /* ë³´ë¬¼ìƒì ì»¨í…Œì´ë„ˆ */
        #chest-container {
            position: absolute;
            bottom: 2%; /* ë°”ë‹¥ì—ì„œ ì•½ê°„ ë„ì›€ */
            left: 50%;
            transform: translateX(-50%);
            width: 25%; /* ìƒì í¬ê¸° ì¡°ì ˆ */
            z-index: 10;
            /* ìƒìê°€ ë¹›ë‚˜ëŠ” íš¨ê³¼ */
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.4));
        }

        #chest-container img {
            width: 100%;
            display: block;
        }

        /* ë–¨ì–´ì§€ëŠ” ì•„ì´í…œ */
        .falling-item {
            position: absolute;
            font-size: 3.5rem; /* ì•„ì´í…œ í¬ê¸° */
            top: -150px;
            z-index: 5;
            /* í•˜ë“œì›¨ì–´ ê°€ì†ì„ ìœ„í•œ ì„¤ì • */
            will-change: transform, top;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
        }

        /* í‘ íš¨ê³¼ */
        .poof {
            position: absolute;
            font-size: 5rem;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
            animation: poofAnim 0.6s ease-out forwards;
        }

        /* ìŒ“ì´ëŠ” í•˜íŠ¸ */
        .heart-stack {
            position: absolute;
            font-size: 2.5rem;
            z-index: 8; /* ìƒì(10)ë³´ë‹¤ëŠ” ë’¤, ë–¨ì–´ì§€ëŠ”ê²ƒ(5)ë³´ë‹¨ ì• */
            transform: translate(-50%, -50%);
            /* í•˜íŠ¸ê°€ ë‚˜íƒ€ë‚  ë•Œ ë¶€ë“œëŸ½ê²Œ */
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            filter: drop-shadow(0 2px 4px rgba(255, 0, 0, 0.3));
        }

        @keyframes poofAnim {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); content: 'âœ¨'; }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); content: 'ğŸ’¥'; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="chest-container">
            <img src="./chest_3d.png" alt="Treasure Chest" id="chest-img">
        </div>
        </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const container = document.getElementById('game-container');
        const chestContainer = document.getElementById('chest-container');

        // ëœë¤ ì•„ì´í…œ 30ì¢… (ë¬¼ê±´ ê´€ë ¨ + ì•½ê°„ì˜ ì¬ë¯¸ ìš”ì†Œ)
        const randomEmojis = [
            "ğŸ’", "ğŸ’", "ğŸ‘‘", "ğŸ’°", "ğŸ", "ğŸ§¸", "ğŸ”‘", "ğŸ”®", "ğŸ“·", "ğŸ“±",
            "ğŸ’»", "âŒš", "ğŸ•¶ï¸", "ğŸ’", "ğŸ‘ ", "ğŸ§¢", "ğŸ¸", "ğŸ¨", "ğŸ”", "ğŸ•",
            "ğŸ©", "ğŸ¦", "ğŸ­", "ğŸš—", "âœˆï¸", "ğŸš€", "ğŸ›¸", "ğŸ»", "ğŸº", "ğŸ¥"
        ];

        // í•˜íŠ¸ ê´€ë¦¬ìš© ë°°ì—´
        const heartPile = []; 
        // Firebase ë¦¬ìŠ¤ë„ˆ ì°¸ì¡° (ë‚˜ì¤‘ì— ëŒ ìˆ˜ ìˆë„ë¡)
        let inputListener = null;

        // ì‹œì‘ ì‹œê°„ ê¸°ë¡
        const startTime = Date.now();

        // Firebase ì—°ê²° ë° ë¦¬ìŠ¤ë‹ ì‹œì‘
        function startListening() {
            const inputRef = db.ref('inputs');
            // child_added: ë°ì´í„°ê°€ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ì‹¤í–‰
            inputListener = inputRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                // í˜ì´ì§€ ë¡œë“œ ì´ì „ì— ìˆë˜ ë°ì´í„°ëŠ” ë¬´ì‹œí•˜ê³ , ìƒˆë¡œ ë“¤ì–´ì˜¨ ê²ƒë§Œ ì²˜ë¦¬
                if (data.timestamp && data.timestamp > startTime) {
                    spawnItem();
                }
            });
        }

        startListening();

        function spawnItem() {
            const item = document.createElement('div');
            item.classList.add('falling-item');
            item.innerText = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
            
            // ìœ„ì¹˜ ê³„ì‚°ì„ ìœ„í•œ ì¤€ë¹„
            const containerRect = container.getBoundingClientRect();
            const chestRect = chestContainer.getBoundingClientRect();

            // 1. ë–¨ì–´ì§€ê¸° ì‹œì‘í•˜ëŠ” ê°€ë¡œ ìœ„ì¹˜ (ìƒì ë„ˆë¹„ ë²”ìœ„ ë‚´ì—ì„œ ëœë¤)
            // ìƒìì˜ ì™¼ìª½ ë ~ ì˜¤ë¥¸ìª½ ë ì‚¬ì´ì˜ ë¹„ìœ¨ì„ ê³„ì‚°
            const chestLeftPercent = ((chestRect.left - containerRect.left) / containerRect.width) * 100;
            const chestRightPercent = ((chestRect.right - containerRect.left) / containerRect.width) * 100;
            
            // ìƒì ë„ˆë¹„ ì•ˆì—ì„œ ì•½ê°„ì˜ ì—¬ìœ (padding)ë¥¼ ë‘ê³  ëœë¤ ìœ„ì¹˜ ì„ ì •
            const padding = 2; // %
            const randomLeft = (chestLeftPercent + padding) + Math.random() * (chestRightPercent - chestLeftPercent - padding * 2);
            
            item.style.left = `${randomLeft}%`;
            
            // 2. ë–¨ì–´ì§€ëŠ” ëª©í‘œ ì§€ì  (ìƒìì˜ ì—´ë¦° ë¶€ë¶„ ì¯¤)
            // ìƒë‹¨ì—ì„œë¶€í„° ìƒì ë†’ì´ì˜ ì ˆë°˜ ì§€ì ê¹Œì§€ ê±°ë¦¬ ê³„ì‚°
            const targetTop = chestRect.top - containerRect.top + (chestRect.height * 0.4); // ìƒì ìƒë‹¨ì—ì„œ 40% ì§€ì 

            // 3. ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •
            const duration = 1.5 + Math.random() * 1; // 1.5 ~ 2.5ì´ˆ
            item.style.animationName = `fall-${Date.now()}`; // ê³ ìœ í•œ ì• ë‹ˆë©”ì´ì…˜ ì´ë¦„
            item.style.animationDuration = `${duration}s`;

            // ë™ì ìœ¼ë¡œ í‚¤í”„ë ˆì„ ìƒì„±í•˜ì—¬ ì •í™•í•œ ìœ„ì¹˜ë¡œ ë–¨ì–´ëœ¨ë¦¼
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes ${item.style.animationName} {
                    from { top: -10%; transform: rotate(0deg); }
                    to { top: ${targetTop}px; transform: rotate(${Math.random() * 360}deg); }
                }
            `;
            item.appendChild(style);
            container.appendChild(item);

            // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ ê°ì§€ (ìƒìì— ë‹¿ì•˜ì„ ë•Œ)
            item.addEventListener('animationend', () => {
                triggerPoof(item);
            });
        }

        function triggerPoof(item) {
            const rect = item.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ
            const left = rect.left - containerRect.left + (rect.width / 2);
            const top = rect.top - containerRect.top + (rect.height / 2);

            item.remove(); // ì•„ì´í…œ ì œê±°

            // 1. í‘ íš¨ê³¼
            const poof = document.createElement('div');
            poof.classList.add('poof');
            poof.innerText = "âœ¨"; 
            poof.style.left = `${left}px`;
            poof.style.top = `${top}px`;
            container.appendChild(poof);
            setTimeout(() => poof.remove(), 600);

            // 2. í•˜íŠ¸ ìŒ“ê¸°
            addHeartToChest(left, top);
        }

        function addHeartToChest(targetX, targetY) {
            const heart = document.createElement('div');
            heart.classList.add('heart-stack');
            heart.innerText = "â¤ï¸";
            
            // ì•„ì´í…œì´ ì‚¬ë¼ì§„ ìœ„ì¹˜ ê·¼ì²˜ì— í•˜íŠ¸ ìƒì„± (ì•½ê°„ì˜ ëœë¤ì„± ì¶”ê°€)
            const randomOffsetX = (Math.random() - 0.5) * 40; // Â±20px
            const randomOffsetY = (Math.random() * 30); // 0 ~ 30px ì•„ë˜ë¡œ

            heart.style.left = `${targetX + randomOffsetX}px`;
            // ìƒì ì•ˆìª½ì— ìŒ“ì´ëŠ” ëŠë‚Œì„ ìœ„í•´ ëª©í‘œ ì§€ì ë³´ë‹¤ ì•½ê°„ ì•„ë˜ì— ë°°ì¹˜
            heart.style.top = `${targetY + randomOffsetY}px`;
            
            // ëœë¤í•œ ê°ë„ë¡œ ê¸°ìš¸ì„
            heart.style.transform = `translate(-50%, -50%) rotate(${Math.random() * 60 - 30}deg)`;

            container.appendChild(heart);
            heartPile.push(heart);

            // ì„±ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì˜¤ë˜ëœ í•˜íŠ¸ ì œê±° (ìµœëŒ€ 150ê°œ ìœ ì§€)
            if (heartPile.length > 150) {
                const oldHeart = heartPile.shift();
                oldHeart.style.transition = 'opacity 0.5s';
                oldHeart.style.opacity = '0';
                setTimeout(() => oldHeart.remove(), 500);
            }
        }
    </script>
</body>
</html>
