<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Emoji Treasure Chest Event</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');

        body {
            margin: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
        }

        #game-container {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            background: radial-gradient(circle at bottom, #512b58 0%, #2c1055 40%, #000000 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        /* ë³´ë¬¼ìƒì */
        #chest-container {
            position: absolute;
            bottom: 10%; /* ë°”ë‹¥ì— ìŒ“ì¼ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ì¡°ê¸ˆ ì˜¬ë¦¼ */
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            z-index: 20; /* ìŒ“ì¸ í•˜íŠ¸ë“¤ë³´ë‹¤ ì•ì— ì˜¤ë„ë¡ */
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.4));
        }

        #chest-container img {
            width: 100%;
            display: block;
        }

        /* íŠ€ì–´ì˜¤ë¥´ëŠ” ì´ëª¨ì§€/í•˜íŠ¸ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .flying-item {
            position: absolute;
            left: 50%; 
            bottom: 20%; /* ìƒì ë‚´ë¶€ ì‹œì‘ì  */
            font-size: 4rem; /* í¬ê¸°ë¥¼ 15rem -> 4remìœ¼ë¡œ ì¶•ì†Œ */
            z-index: 10; /* ìƒì ë’¤ì—ì„œ ë‚˜ì™€ì„œ ë°”ë‹¥ì— ê¹”ë¦¼ */
            user-select: none;
            pointer-events: none;
            will-change: transform, opacity;
            
            /* CSS ë³€ìˆ˜ë¡œ ëœë¤ ë„ì°© ì§€ì  ì œì–´ */
            --end-x: 0px; 
            --end-y: 0px;
            --rotate-end: 0deg;

            /* ì• ë‹ˆë©”ì´ì…˜: 1.5ì´ˆ ë™ì•ˆ íŠ€ì–´ì˜¬ë¼ ë°”ë‹¥ì— ì•ˆì°© */
            animation: jumpAndFall 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        /* ë³€ì‹ í•  ë•Œ 'í‘' í•˜ëŠ” íš¨ê³¼ */
        .poof-effect {
            animation: poofScale 0.3s ease-out forwards;
        }

        /* ì´ë¯¸ ë°”ë‹¥ì— ë–¨ì–´ì§„ í•˜íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ í´ë˜ìŠ¤) */
        .landed {
            position: absolute;
            z-index: 5; /* ìƒìë³´ë‹¤ ë’¤, ë°°ê²½ë³´ë‹¤ ì• */
            animation: none; /* ì• ë‹ˆë©”ì´ì…˜ ë©ˆì¶¤ */
            transform: translate(var(--end-x), var(--end-y)) rotate(var(--rotate-end));
            /* ë°”ë‹¥ì— ìˆëŠ” í•˜íŠ¸ëŠ” ì€ì€í•˜ê²Œ ë‘ê·¼ê±°ë¦¼ */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        /* ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
        @keyframes jumpAndFall {
            0% {
                opacity: 0;
                transform: translate(-50%, 0) scale(0.5);
            }
            10% {
                opacity: 1;
            }
            50% {
                /* ê³µì¤‘ ê°€ì¥ ë†’ì€ ê³³ (ìœ„ë¡œ ì†Ÿêµ¬ì¹¨) */
                transform: translate(-50%, -300px) scale(1.2);
            }
            100% {
                /* ë°”ë‹¥ ëœë¤ ìœ„ì¹˜ë¡œ ë‚™í•˜ */
                transform: translate(var(--end-x), var(--end-y)) rotate(var(--rotate-end)) scale(1);
            }
        }

        /* ë³€ì‹  ì‹œ ìˆœê°„ì ìœ¼ë¡œ ì»¤ì¡Œë‹¤ ì‘ì•„ì§€ëŠ” íš¨ê³¼ */
        @keyframes poofScale {
            0% { filter: brightness(2); transform: scale(1.5); }
            50% { filter: brightness(1.5); transform: scale(0.8); }
            100% { filter: brightness(1); transform: scale(1); }
        }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="pile-container"></div>

        <div id="chest-container">
            <img src="./chest_3d.png" alt="Treasure Chest" id="chest-img">
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const chestContainer = document.getElementById('chest-container');
        const pileContainer = document.getElementById('pile-container'); // í•˜íŠ¸ê°€ ìŒ“ì¼ ê³³
        
        let inputListener = null;
        const startTime = Date.now();

        function startListening() {
            const inputRef = db.ref('inputs');
            inputListener = inputRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (data.timestamp && data.timestamp > startTime) {
                    
                    // Firebaseì—ì„œ ë°›ì€ í…ìŠ¤íŠ¸(ì´ëª¨ì§€) ì¶”ì¶œ
                    // ì˜ˆ: data.text, data.message, data.emoji ë“± ì‹¤ì œ í•„ë“œëª…ì— ë§ê²Œ ìˆ˜ì • í•„ìš”
                    // ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ ì—¬ëŸ¬ í•„ë“œë¥¼ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    const receivedEmoji = data.emoji || data.text || data.message || "â“";

                    spawnEmojiToHeart(receivedEmoji);
                }
            });
        }

        startListening();

        function spawnEmojiToHeart(emojiChar) {
            // 1. ìš”ì†Œ ìƒì„±
            const item = document.createElement('div');
            item.classList.add('flying-item');
            item.innerText = emojiChar; // ì²˜ìŒì—” ë°›ì€ ì´ëª¨ì§€ë¡œ ì‹œì‘

            // 2. ëœë¤ ë„ì°© ìœ„ì¹˜ ê³„ì‚° (ìƒì ì£¼ë³€ ë°”ë‹¥ì— ìŒ“ì´ë„ë¡)
            // x: -200px ~ 200px (ìƒì ì¤‘ì‹¬ ê¸°ì¤€ ì¢Œìš°)
            // y: 50px ~ 150px (ìƒì ë°”ë‹¥ ê·¼ì²˜)
            const randomX = (Math.random() * 500) - 250; 
            const randomY = (Math.random() * 100) + 20; 
            const randomRotate = (Math.random() * 60) - 30;

            // CSS ë³€ìˆ˜ì— ëœë¤ ê°’ ì£¼ì…
            item.style.setProperty('--end-x', `${randomX}px`);
            item.style.setProperty('--end-y', `${randomY}px`);
            item.style.setProperty('--rotate-end', `${randomRotate}deg`);

            // ìƒì ì•ˆì— ì¶”ê°€ (ì´ˆê¸° ìœ„ì¹˜ ì¡ê¸° ìœ„í•¨)
            chestContainer.appendChild(item);

            // 3. ë³€ì‹  ë¡œì§ (íƒ€ì´ë° ì¡°ì ˆ)
            // ì• ë‹ˆë©”ì´ì…˜ ì „ì²´ê°€ 1.5ì´ˆì´ê³ , 50% ì§€ì (0.75ì´ˆ)ì´ ê°€ì¥ ë†’ì€ ê³³(Top)ì…ë‹ˆë‹¤.
            // ê³µì¤‘ì— ë–´ì„ ë•Œ í•˜íŠ¸ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
            setTimeout(() => {
                // í…ìŠ¤íŠ¸ ë³€ê²½
                item.innerText = "â¤ï¸";
                
                // í‘ í„°ì§€ëŠ” íš¨ê³¼ í´ë˜ìŠ¤ ì¶”ê°€ (ë°˜ì§ì„ ë“±)
                item.classList.add('poof-effect');
                
                // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•´ ê¸°ì¡´ transform ìŠ¤íƒ€ì¼ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ì£¼ì˜
                // (CSS animationì´ transformì„ ì œì–´ ì¤‘ì´ë¯€ë¡œ í…ìŠ¤íŠ¸ë§Œ ë°”ê¿”ë„ ë¨)
            }, 750); // 0.75ì´ˆ (ì• ë‹ˆë©”ì´ì…˜ ì¤‘ê°„ ì§€ì )

            // 4. ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ ì²˜ë¦¬ (ìŒ“ì´ê¸°)
            item.addEventListener('animationend', () => {
                // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±° (ì¶©ëŒ ë°©ì§€)
                item.classList.remove('flying-item');
                item.classList.remove('poof-effect');
                
                // "ë°”ë‹¥ì— ë–¨ì–´ì§„ ìƒíƒœ" í´ë˜ìŠ¤ ì¶”ê°€
                item.classList.add('landed');

                // ì¤‘ìš”: í˜„ì¬ ìƒì(chestContainer) ì•ˆì— ìˆìœ¼ë©´ ìƒìê°€ ì›€ì§ì¼ ë•Œ ê°™ì´ ì›€ì§ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
                // ë°”ê¹¥ì˜ ê³ ì •ëœ ë°°ê²½ ì»¨í…Œì´ë„ˆ(pileContainer)ë‚˜ game-containerë¡œ ì˜®ê²¨ì¤ë‹ˆë‹¤.
                // ë‹¤ë§Œ, ìœ„ì¹˜ ê³„ì‚°ì´ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” 
                // chestContainer ë‚´ë¶€ì—ì„œ positionì„ ê³ ì •í•˜ê±°ë‚˜,
                // ì‹œê°ì ìœ¼ë¡œ ë¬¸ì œì—†ë‹¤ë©´ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
                
                // ë” ìì—°ìŠ¤ëŸ¬ìš´ ìŒ“ì„ì„ ìœ„í•´ z-indexë¥¼ ëœë¤í•˜ê²Œ ì£¼ì–´ 
                // ì–´ë–¤ ê±´ ì•ì—, ì–´ë–¤ ê±´ ë’¤ì— ìŒ“ì´ê²Œ í•¨
                item.style.zIndex = Math.floor(Math.random() * 10);
            });
        }
        
        // í…ŒìŠ¤íŠ¸ìš©: í™”ë©´ í´ë¦­ ì‹œ ëœë¤ ì´ëª¨ì§€ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
        document.body.addEventListener('click', () => {
             const randomEmojis = ["ğŸ¦", "ğŸ¯", "ğŸ˜€", "ğŸ”¥", "ğŸ’", "ğŸ‘»"];
             const pick = randomEmojis[Math.floor(Math.random() * randomEmojis.length)];
             spawnEmojiToHeart(pick);
        });

    </script>
</body>
</html>
